<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.astraapi.repository.TestingRepository">
    <insert id="save" useGeneratedKeys="true" keyColumn="id" keyProperty="entity.id">
        insert into public.testings(exam_id, specialization_id, status)
        values (#{entity.examId}, #{entity.specializationId}, #{entity.status})
    </insert>

    <select id="getByExamIdWithSpecialization" resultMap="testingWithSpecialization">
        select t.id       as id,
               t.exam_id  as examId,
               t.status   as status,
               s.id       as specializationId,
               s.title    as specializationTitle,
               step.id    as stepId,
               step.title as stepTitle
        from public.testings t
                 left join public.specializations s on s.id = t.specialization_id
                 left join public.steps step on step.id = s.step_id
        where t.exam_id = #{examId}
        order by t.id
    </select>

    <select id="findTestingInfoById" resultMap="testingInfo">
        select t.id     as id,
               t.status as status,
               e.id     as examId,
               e.title  as examTitle,
               s.id     as specializationId,
               s.title  as specializationTitle
        from public.testings t
                 left join public.exams e on e.id = t.exam_id
                 left join public.specializations s on s.id = t.specialization_id
        where t.id = #{id}
    </select>

    <select id="getTestingTestsByTestingId" resultMap="testingTestQuestion">
        select tt.id         as id,
               tt.testing_id as testingId,
               t.id          as testId,
               t.question    as testQuestion
        from public.testings_tests tt
                 left join public.tests t on t.id = tt.test_id
        where tt.testing_id = #{testingId}
    </select>

    <select id="getAvailable" resultMap="testingWithExamAndSubject">
        select t.id              as id,
               e.id              as examId,
               e.title           as examTitle,
               s.id              as specializationId,
               s.title           as specializationTitle,
               count(tt.test_id) as testsCount
        from public.testings t
                 left join public.exams e on e.id = t.exam_id
                 left join public.specializations s on s.id = t.specialization_id
                 left join public.testings_tests tt on t.id = tt.testing_id
        where t.status = 'ACTIVE'
        group by t.id, e.id, s.id
        having count(tt.test_id) > 0
        order by e.id, s.id
    </select>

    <select id="getByExamIdAndSpecializationId" resultType="com.example.astraapi.entity.TestingEntity">
        select *
        from public.testings t
        where t.exam_id = #{examId}
          and t.specialization_id = #{specializationId}
    </select>

    <select id="getTestsCount" resultType="java.lang.Long">
        select count(id)
        from public.testings_tests tt
        where tt.testing_id = #{id}
    </select>

    <update id="updateStatusById">
        update public.testings
        set status = #{status}
        where id = #{id}
    </update>

    <resultMap id="testingWithSpecialization" type="com.example.astraapi.entity.TestingWithSpecializationEntity">
        <id column="id" property="id"/>
        <result column="examId" property="examId"/>
        <result column="status" property="status"/>

        <association property="specialization"
                     javaType="com.example.astraapi.entity.projection.StepSpecializationProjection">
            <id column="specializationId" property="id"/>
            <result column="specializationTitle" property="title"/>

            <association property="step" javaType="com.example.astraapi.entity.StepEntity">
                <id column="stepId" property="id"/>
                <result column="stepTitle" property="title"/>
            </association>
        </association>
    </resultMap>

    <resultMap id="testingInfo" type="com.example.astraapi.entity.TestingInfoEntity">
        <id column="id" property="id"/>
        <result column="status" property="status"/>

        <association property="exam" javaType="com.example.astraapi.entity.ExamEntity">
            <id column="examId" property="id"/>
            <result column="examTitle" property="title"/>
        </association>

        <association property="specialization" javaType="com.example.astraapi.entity.SpecializationEntity">
            <id column="specializationId" property="id"/>
            <result column="specializationTitle" property="title"/>
        </association>
    </resultMap>

    <resultMap id="testingTestQuestion" type="com.example.astraapi.entity.TestingTestQuestionEntity">
        <id column="id" property="id"/>
        <result column="testingId" property="testingId"/>

        <association property="test" javaType="com.example.astraapi.entity.TestQuestionEntity">
            <id column="testId" property="id"/>
            <result column="testQuestion" property="question"/>
        </association>
    </resultMap>

    <resultMap id="testingWithExamAndSubject" type="com.example.astraapi.entity.TestingEntity">
        <id column="id" property="id"/>

        <association property="exam" javaType="com.example.astraapi.entity.ExamEntity">
            <id column="examId" property="id"/>
            <result column="examTitle" property="title"/>
        </association>

        <association property="specialization" javaType="com.example.astraapi.entity.SpecializationEntity">
            <id column="specializationId" property="id"/>
            <result column="specializationTitle" property="title"/>
        </association>
    </resultMap>
</mapper>
