<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.astraapi.repository.TestRepository">
    <insert id="save" parameterType="com.example.astraapi.entity.TestEntity" useGeneratedKeys="true"
            keyProperty="entity.id">
        insert into public.tests(question, comment)
        values (#{entity.question}, #{entity.comment})
    </insert>

    <select id="getAll" resultMap="testShortDetail">
        select t.id       as id,
               t.question as question,
               t.comment  as comment,
               e.id       as examId,
               e.title    as examTitle,
               s.id       as specializationId,
               s.title    as specializationTitle
        from public.tests t
                 left join public.tests_exams te on t.id = te.test_id
                 left join public.exams e on te.exam_id = e.id
                 left join public.tests_subjects ts on t.id = ts.test_id
                 left join public.subjects_specializations ss on ts.subject_id = ss.subject_id
                 left join public.specializations s on ss.specialization_id = s.id
        order by id, examId, specializationId
    </select>

    <select id="getDetailedTestById" resultMap="testFullDetail">
        select t.id           as id,
               t.question     as question,
               t.comment      as comment,
               tv.id          as variantId,
               tv.title       as variantTitle,
               tv.explanation as variantExplanation,
               tv.is_correct  as variantIsCorrect,
               e.id           as examId,
               e.title        as examTitle,
               s.id           as subjectId,
               s.title        as subjectTitle
        from public.tests t
                 left join public.tests_exams te on t.id = te.test_id
                 left join public.exams e on te.exam_id = e.id
                 left join public.tests_variants tv on t.id = tv.test_id
                 left join public.tests_subjects ts on t.id = ts.test_id
                 left join public.subjects s on ts.subject_id = s.id
        where t.id = #{id}
    </select>

    <select id="getTestingBySpecializationIdAndGoodId" resultMap="testingTest">
        select *
        from (
                 select *
                 from (
                          select distinct on (t.id) t.id                  as id,
                                                    t.question            as question,
                                                    t.comment             as comment,
                                                    specializations.id    as specializationId,
                                                    specializations.title as specializationTitle
                          from public.tests t
                                   left join tests_subjects ts on t.id = ts.test_id
                                   left join public.subjects_specializations ss on ss.subject_id = ts.subject_id
                                   left join public.specializations on ss.specialization_id = specializations.id
                                   left join tests_exams te on t.id = te.test_id
                          where specialization_id = #{specializationId}
                            and te.exam_id = #{examId}
                          order by t.id
                      ) as subsubtable
                 order by random()
                 limit #{count}
             ) as subtable
                 join lateral (
            select tv.id          as variantId,
                   tv.title       as variantTitle,
                   tv.test_id     as variantTestId,
                   tv.explanation as variantExplanation,
                   tv.is_correct  as variantIsCorrect
            from public.tests_variants tv
            where tv.test_id = subtable.id
            order by random()
            ) as variants on true
        order by random()
    </select>

    <resultMap id="testShortDetail" type="com.example.astraapi.entity.TestShortDetailEntity">
        <id column="id" property="id"/>
        <result column="question" property="question"/>
        <result column="comment" property="comment"/>

        <collection property="exams" javaType="List" ofType="com.example.astraapi.entity.ExamEntity">
            <id column="examId" property="id"/>
            <result column="examTitle" property="title"/>
        </collection>

        <collection property="specializations" javaType="List"
                    ofType="com.example.astraapi.entity.SpecializationEntity">
            <id column="specializationId" property="id"/>
            <result column="specializationTitle" property="title"/>
        </collection>
    </resultMap>

    <resultMap id="testFullDetail" type="com.example.astraapi.entity.TestFullDetailEntity">
        <id column="id" property="id" />
        <result column="question" property="question" />
        <result column="comment" property="comment" />

        <collection property="variants" javaType="List" ofType="com.example.astraapi.entity.TestVariantEntity">
            <id column="variantId" property="id" />
            <result column="variantTitle" property="title" />
            <result column="variantExplanation" property="explanation" />
            <result column="variantIsCorrect" property="correct" />
        </collection>

        <collection property="exams" javaType="List" ofType="com.example.astraapi.entity.ExamEntity">
            <id column="examId" property="id" />
            <result column="examTitle" property="title" />
        </collection>

        <collection property="subjects" javaType="List" ofType="com.example.astraapi.entity.SubjectEntity">
            <id column="subjectId" property="id" />
            <result column="subjectTitle" property="title" />
        </collection>
    </resultMap>

    <resultMap id="testingTest" type="com.example.astraapi.entity.TestingTestEntity">
        <id column="id" property="id"/>
        <result column="question" property="question"/>
        <result column="comment" property="comment"/>

        <collection property="variants" javaType="List" ofType="com.example.astraapi.entity.TestVariantEntity">
            <id column="variantId" property="id"/>
            <result column="variantTestId" property="testId"/>
            <result column="variantTitle" property="title"/>
            <result column="variantExplanation" property="explanation"/>
            <result column="variantIsCorrect" property="correct"/>
        </collection>
    </resultMap>
</mapper>
